let __="undefined"!=typeof wp&&wp.i18n&&wp.i18n.__?wp.i18n.__:function(text){return text};class PollsDashboard{constructor(){this.elements={dashboard:document.querySelector(".polls-dashboard"),tabs:document.querySelectorAll(".polls-tab"),grid:document.querySelector(".polls-grid"),cards:document.querySelectorAll(".poll-card"),panel:document.getElementById("polls-panel"),panelOverlay:document.getElementById("polls-panel-overlay"),createBtn:document.getElementById("polls-create-btn"),createBtnEmpty:document.getElementById("polls-create-btn-empty"),closeBtn:document.getElementById("polls-panel-close"),form:document.getElementById("polls-form"),answerList:document.getElementById("type_text"),answerLists:document.querySelectorAll(".polls-answers__list"),statsPublished:document.querySelector('.polls-stat[data-status="publish"]'),statsPending:document.querySelector('.polls-stat[data-status="pending"]'),statsDrafts:document.querySelector('.polls-stat[data-status="draft"]'),statsTotal:document.querySelector('.polls-stat[data-status="all"]'),toastContainer:null},this.state={currentFilter:"all",isPanelOpen:!1,editingPollId:null,sortables:[]},this.elements.dashboard&&this.init()}init(){this.createToastContainer(),this.bindTabEvents(),this.bindPanelEvents(),this.bindCardActions(),this.bindShortcodeCopy(),this.bindFormEvents(),this.initSortable(),this.handleUrlParams(),this.updateStats()}createToastContainer(){let container=document.querySelector(".polls-toast-container");container||((container=document.createElement("div")).className="polls-toast-container",container.setAttribute("aria-live","polite"),container.setAttribute("aria-atomic","true"),document.body.appendChild(container)),this.elements.toastContainer=container}bindTabEvents(){this.elements.tabs.forEach(tab=>{tab.addEventListener("keydown",e=>this.handleTabKeydown(e))});var urlParams=new URLSearchParams(window.location.search);this.state.currentFilter=urlParams.get("status")||"all"}handleTabClick(e){e=e.currentTarget.dataset.status||"all";this.state.currentFilter=e}handleTabKeydown(e){var tabs=Array.from(this.elements.tabs),currentIndex=tabs.indexOf(e.currentTarget);let nextIndex;switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),nextIndex=(currentIndex+1)%tabs.length;break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),nextIndex=(currentIndex-1+tabs.length)%tabs.length;break;case"Home":e.preventDefault(),nextIndex=0;break;case"End":e.preventDefault(),nextIndex=tabs.length-1;break;default:return}tabs[nextIndex].focus()}setActiveTab(activeTab){this.elements.tabs.forEach(tab=>{tab.setAttribute("aria-selected","false"),tab.classList.remove("is-active")}),activeTab.setAttribute("aria-selected","true"),activeTab.classList.add("is-active")}filterCards(filter){var urlParams;filter||(urlParams=new URLSearchParams(window.location.search),filter=urlParams.get("status")||"all"),this.elements.cards.forEach(card=>{var status=card.dataset.status,status="all"===filter||status===filter;card.style.display=status?"":"none",card.setAttribute("aria-hidden",!status)}),this.checkEmptyState(filter)}checkEmptyState(filter){var visibleCards=Array.from(this.elements.cards).filter(card=>"none"!==card.style.display);let emptyState=this.elements.grid.querySelector(".polls-empty");0===visibleCards.length?(emptyState||(emptyState=this.createEmptyState(filter),this.elements.grid.appendChild(emptyState)),emptyState.style.display=""):emptyState&&(emptyState.style.display="none")}createEmptyState(filter){var wrapper=document.createElement("div"),messages=(wrapper.className="polls-empty",wrapper.style.gridColumn="1 / -1",{all:__("No polls yet","buddypress-polls"),publish:__("No published polls","buddypress-polls"),pending:__("No pending polls","buddypress-polls"),draft:__("No draft polls","buddypress-polls")}),icon=document.createElementNS("http://www.w3.org/2000/svg","svg"),path=(icon.setAttribute("class","polls-empty__icon"),icon.setAttribute("viewBox","0 0 24 24"),icon.setAttribute("fill","none"),icon.setAttribute("stroke","currentColor"),icon.setAttribute("stroke-width","1.5"),document.createElementNS("http://www.w3.org/2000/svg","path")),path=(path.setAttribute("d","M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"),icon.appendChild(path),wrapper.appendChild(icon),document.createElement("h3")),icon=(path.className="polls-empty__title",path.textContent=messages[filter]||messages.all,wrapper.appendChild(path),document.createElement("p"));return icon.className="polls-empty__text",icon.textContent=__("Create your first poll to get started.","buddypress-polls"),wrapper.appendChild(icon),wrapper}updateStats(){Array.from(this.elements.cards).filter(card=>"none"!==card.style.display)}bindPanelEvents(){this.elements.createBtn&&this.elements.createBtn.addEventListener("click",e=>{e.preventDefault(),this.openPanel()}),this.elements.createBtnEmpty&&this.elements.createBtnEmpty.addEventListener("click",e=>{e.preventDefault(),this.openPanel()}),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",e=>{e.preventDefault(),this.closePanel()}),this.elements.panelOverlay&&this.elements.panelOverlay.addEventListener("click",()=>{this.closePanel()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.state.isPanelOpen&&this.closePanel()});var cancelBtn=document.getElementById("polls-panel-cancel");cancelBtn&&cancelBtn.addEventListener("click",e=>{e.preventDefault(),this.closePanel()})}openPanel(pollId=null){var title;this.elements.panel&&(this.state.isPanelOpen=!0,this.state.editingPollId=pollId,this.elements.panel.classList.add("is-open"),this.elements.panel.setAttribute("aria-hidden","false"),this.elements.panelOverlay&&this.elements.panelOverlay.classList.add("is-visible"),document.body.style.overflow="hidden",(title=this.elements.panel.querySelector(".polls-panel__title"))&&(title.textContent=pollId?__("Edit Poll","buddypress-polls"):__("Create New Poll","buddypress-polls")),(title=document.getElementById("polls-form-submit"))&&(title=title.querySelector(".polls-btn__text"))&&(title.textContent=pollId?__("Update Poll","buddypress-polls"):__("Create Poll","buddypress-polls")),setTimeout(()=>{var firstInput=this.elements.panel.querySelector('input[type="text"], textarea');firstInput&&firstInput.focus()},350),pollId?this.loadPollData(pollId):this.resetForm())}closePanel(){var url;this.elements.panel&&(this.state.isPanelOpen=!1,this.state.editingPollId=null,this.elements.panel.classList.remove("is-open"),this.elements.panel.setAttribute("aria-hidden","true"),this.elements.panelOverlay&&this.elements.panelOverlay.classList.remove("is-visible"),document.body.style.overflow="",window.history)&&window.history.pushState&&(url=window.location.pathname,window.history.pushState({},"",url))}bindCardActions(){this.elements.grid&&this.elements.grid.addEventListener("click",e=>{var pollId,card,action=e.target.closest("[data-action]");action&&(e.preventDefault(),e=action.dataset.action,pollId=action.dataset.id,card=action.closest(".poll-card"),this.handleCardAction(e,pollId,action,card))})}bindShortcodeCopy(){this.elements.grid&&this.elements.grid.addEventListener("click",e=>{let copyBtn=e.target.closest(".poll-card__shortcode-copy");copyBtn&&(e.preventDefault(),e=copyBtn.dataset.pollId)&&this.copyToClipboard('[wbpoll id="'+e+'"]').then(()=>{copyBtn.classList.add("copied"),this.showToast(__("Shortcode copied!","buddypress-polls"),"success"),setTimeout(()=>{copyBtn.classList.remove("copied")},2e3)}).catch(err=>{console.error("Failed to copy:",err),this.showToast(__("Failed to copy shortcode","buddypress-polls"),"error")})})}copyToClipboard(text){return navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(text):new Promise((resolve,reject)=>{var textarea=document.createElement("textarea");textarea.value=text,textarea.style.position="fixed",textarea.style.left="-9999px",textarea.style.top="0",textarea.setAttribute("readonly",""),document.body.appendChild(textarea);try{textarea.select(),textarea.setSelectionRange(0,text.length);var success=document.execCommand("copy");document.body.removeChild(textarea),success?resolve():reject(new Error("execCommand copy failed"))}catch(err){document.body.removeChild(textarea),reject(err)}})}handleCardAction(actionType,pollId,btn,card){switch(actionType){case"view":this.viewPoll(pollId);break;case"edit":this.editPoll(pollId,btn);break;case"pause":this.pausePoll(pollId,btn,card);break;case"resume":this.resumePoll(pollId,btn,card);break;case"delete":this.deletePoll(pollId,btn,card);break;case"publish":this.publishPoll(pollId,btn,card);break;case"unpublish":this.unpublishPoll(pollId,btn,card)}}viewPoll(pollId){pollId=document.querySelector('[data-action="view"][data-id="'+pollId+'"]');pollId&&pollId.dataset.url&&(window.location.href=pollId.dataset.url)}editPoll(pollId,btn){this.setButtonLoading(btn,!0),this.openPanel(pollId),setTimeout(()=>{this.setButtonLoading(btn,!1)},500)}pausePoll(pollId,btn,card){this.apiRequest("/wp-json/wbpoll/v1/listpoll/pause/poll",{pollid:pollId,_wbpoll_pause_poll:1},btn).then(response=>{response.success&&(this.showToast(__("Poll paused","buddypress-polls"),"success"),this.updateCardStatus(card,"paused"))})}resumePoll(pollId,btn,card){this.apiRequest("/wp-json/wbpoll/v1/listpoll/pause/poll",{pollid:pollId,_wbpoll_pause_poll:0},btn).then(response=>{response.success&&(this.showToast(__("Poll resumed","buddypress-polls"),"success"),this.updateCardStatus(card,"publish"))})}deletePoll(pollId,btn,card){confirm(__("Are you sure you want to delete this poll?","buddypress-polls"))&&this.apiRequest("/wp-json/wbpoll/v1/listpoll/delete/poll",{pollid:pollId},btn).then(response=>{response.success&&(this.showToast(__("Poll deleted","buddypress-polls"),"success"),card.remove(),this.updateStats(),this.checkEmptyState(this.state.currentFilter))})}publishPoll(pollId,btn,card){this.apiRequest("/wp-json/wbpoll/v1/listpoll/publish/poll",{pollid:pollId},btn).then(response=>{response.success&&(this.showToast(__("Poll published","buddypress-polls"),"success"),this.updateCardStatus(card,"publish"))})}unpublishPoll(pollId,btn,card){this.apiRequest("/wp-json/wbpoll/v1/listpoll/unpublish/poll",{pollid:pollId},btn).then(response=>{response.success&&(this.showToast(__("Poll unpublished","buddypress-polls"),"success"),this.updateCardStatus(card,"draft"))})}updateCardStatus(card,newStatus){card.dataset.status=newStatus;var statusBadge=card.querySelector(".poll-card__status");if(statusBadge){statusBadge.classList.remove("poll-card__status--active","poll-card__status--paused","poll-card__status--draft","poll-card__status--pending");var statusMap={publish:{class:"poll-card__status--active",text:__("Active","buddypress-polls")},paused:{class:"poll-card__status--paused",text:__("Paused","buddypress-polls")},draft:{class:"poll-card__status--draft",text:__("Draft","buddypress-polls")},pending:{class:"poll-card__status--pending",text:__("Pending","buddypress-polls")}},statusMap=statusMap[newStatus]||statusMap.draft;for(statusBadge.classList.add(statusMap.class);statusBadge.firstChild;)statusBadge.removeChild(statusBadge.firstChild);var dot=document.createElement("span");dot.className="poll-card__status-dot",statusBadge.appendChild(dot),statusBadge.appendChild(document.createTextNode(statusMap.text))}dot=card.querySelector('[data-action="pause"], [data-action="resume"]');dot&&("paused"===newStatus?(dot.dataset.action="resume",dot.setAttribute("data-tooltip",__("Resume","buddypress-polls"))):(dot.dataset.action="pause",dot.setAttribute("data-tooltip",__("Pause","buddypress-polls")))),this.filterCards(this.state.currentFilter),this.updateStats()}setButtonLoading(btn,loading){if(btn)if(loading){for(btn._originalContent=Array.from(btn.childNodes);btn.firstChild;)btn.removeChild(btn.firstChild);loading=document.createElement("span");loading.className="polls-spinner",loading.style.cssText="width:16px;height:16px;border-width:2px;",btn.appendChild(loading),btn.style.pointerEvents="none"}else{for(;btn.firstChild;)btn.removeChild(btn.firstChild);btn._originalContent&&btn._originalContent.forEach(node=>{btn.appendChild(node.cloneNode(!0))}),btn.style.pointerEvents=""}}apiRequest(endpoint,data,btn=null){var siteUrl="undefined"!=typeof wbpollpublic?wbpollpublic.url:"",nonce="undefined"!=typeof wbpollpublic?wbpollpublic.rest_nonce:"";return btn&&this.setButtonLoading(btn,!0),fetch(siteUrl+endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":nonce},body:JSON.stringify(data)}).then(response=>response.json()).then(result=>(result.success||this.showToast(result.message||__("An error occurred","buddypress-polls"),"error"),result)).catch(error=>(console.error("API Error:",error),this.showToast(__("Network error. Please try again.","buddypress-polls"),"error"),{success:!1})).finally(()=>{btn&&this.setButtonLoading(btn,!1)})}bindFormEvents(){let form=document.getElementById("polls-form");form&&form.addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(form)}),document.querySelectorAll('input[name="poll_type"]').forEach(radio=>{radio.addEventListener("change",e=>this.handlePollTypeChange(e.target.value))});document.querySelectorAll('input[name="_wbpoll_never_expire"]').forEach(radio=>{radio.addEventListener("change",e=>this.handleExpiryChange(e.target.value))});var addAnswerBtn=document.getElementById("polls-add-answer"),addAnswerBtn=(addAnswerBtn&&addAnswerBtn.addEventListener("click",e=>{e.preventDefault(),this.addAnswerField()}),document.getElementById("polls-answers"));addAnswerBtn&&addAnswerBtn.addEventListener("click",e=>{var removeBtn=e.target.closest(".polls-answer__remove");removeBtn&&(removeBtn=removeBtn.closest(".polls-answer"))&&(e.preventDefault(),this.removeAnswerField(removeBtn))}),this.initCharacterCounters()}initCharacterCounters(){var titleInput=document.getElementById("polltitle"),titleInput=(titleInput&&titleInput.hasAttribute("data-char-limit")&&(this.bindCharacterCounter(titleInput),this.updateCharacterCount(titleInput)),document.getElementById("poll-content")),titleInput=(titleInput&&"TEXTAREA"===titleInput.tagName&&titleInput.hasAttribute("data-char-limit")&&(this.bindCharacterCounter(titleInput),this.updateCharacterCount(titleInput)),document.querySelector('.polls-form__char-counter[data-for="poll-content"]'));if(titleInput&&"undefined"!=typeof tinyMCE){let limit=parseInt(titleInput.dataset.limit,10);0<limit&&setTimeout(()=>{this.initTinyMCECharCounter(limit)},500)}titleInput=document.getElementById("polls-answers");if(titleInput){let answerLimit=parseInt(titleInput.dataset.answerLimit,10)||0;0<answerLimit&&(this.applyAnswerLimits(answerLimit),titleInput.addEventListener("input",e=>{e.target.classList.contains("wbpoll_answer")&&e.target.value.length>answerLimit&&(e.target.value=e.target.value.substring(0,answerLimit))}))}}applyAnswerLimits(limit){document.querySelectorAll(".wbpoll_answer").forEach(input=>{input.setAttribute("maxlength",limit),input.setAttribute("data-char-limit",limit)})}bindCharacterCounter(input){input.addEventListener("input",()=>this.updateCharacterCount(input)),input.addEventListener("paste",()=>{setTimeout(()=>this.updateCharacterCount(input),0)})}updateCharacterCount(input){var count,counterId=input.id,counterId=document.querySelector(`.polls-form__char-counter[data-for="${counterId}"] .char-count`);counterId&&(count=input.value.length,counterId.textContent=count,input=parseInt(input.getAttribute("data-char-limit"),10),counterId=counterId.closest(".polls-form__char-counter"))&&(input<=count?(counterId.classList.add("polls-form__char-counter--limit"),counterId.classList.remove("polls-form__char-counter--warning")):.9*input<=count?(counterId.classList.add("polls-form__char-counter--warning"),counterId.classList.remove("polls-form__char-counter--limit")):counterId.classList.remove("polls-form__char-counter--warning","polls-form__char-counter--limit"))}initTinyMCECharCounter(limit){let editor=tinyMCE.get("poll-content");var updateCount;editor&&(updateCount=()=>{var content=editor.getContent({format:"text"}),count=content.length,counter=document.querySelector('.polls-form__char-counter[data-for="poll-content"] .char-count');counter&&(counter.textContent=count,counter=counter.closest(".polls-form__char-counter"))&&(limit<=count?(counter.classList.add("polls-form__char-counter--limit"),counter.classList.remove("polls-form__char-counter--warning")):.9*limit<=count?(counter.classList.add("polls-form__char-counter--warning"),counter.classList.remove("polls-form__char-counter--limit")):counter.classList.remove("polls-form__char-counter--warning","polls-form__char-counter--limit")),limit<count&&(counter=content.substring(0,limit),editor.setContent(counter),editor.selection.select(editor.getBody(),!0),editor.selection.collapse(!1))},editor.on("keyup change paste",updateCount),updateCount())}handlePollTypeChange(pollType){console.log("[PollsDashboard] Poll type changed to:",pollType);document.querySelectorAll(".polls-form__type-card").forEach(card=>{var radio=card.querySelector('input[type="radio"]');radio&&radio.value===pollType?card.classList.add("polls-form__type-card--selected"):card.classList.remove("polls-form__type-card--selected")});var hiddenSelect=document.getElementById("poll_type"),hiddenSelect=(hiddenSelect&&(hiddenSelect.value=pollType),document.querySelectorAll(".polls-answers__list").forEach(list=>{(list.dataset.pollType||list.id.replace("type_",""))===pollType||"default"===pollType&&"type_text"===list.id?list.style.display="":list.style.display="none"}),{default:"type_text",image:"type_image",video:"type_video",audio:"type_audio",html:"type_html"}[pollType]||"type_text");this.elements.answerList=document.getElementById(hiddenSelect),this.initSortable()}handleExpiryChange(value){var datesContainer=document.getElementById("polls-dates"),showResultAfterExpire=document.getElementById("polls-show-result-after-expire");document.querySelectorAll(".polls-form__expiry-option").forEach(option=>{var radio=option.querySelector('input[type="radio"]');radio&&radio.value===value?option.classList.add("polls-form__expiry-option--selected"):option.classList.remove("polls-form__expiry-option--selected")}),datesContainer&&(datesContainer.style.display="1"===value?"none":""),showResultAfterExpire&&(showResultAfterExpire.style.display="1"===value?"none":"","1"===value)&&(datesContainer=showResultAfterExpire.querySelector('input[name="_wbpoll_show_result_before_expire"][value="0"]'))&&(datesContainer.checked=!0)}getSelectedPollType(){var checkedRadio=document.querySelector('input[name="poll_type"]:checked');return checkedRadio?checkedRadio.value:"default"}handleFormSubmit(form){let submitBtn=document.getElementById("polls-form-submit");var pollId=document.getElementById("poll_id")?.value||"";let isEditing=!!pollId;var title=document.getElementById("polltitle")?.value?.trim();if(title){let pollType=this.getSelectedPollType(),content="";content="undefined"!=typeof tinyMCE&&(editor=tinyMCE.get("poll-content"))?editor.getContent():document.getElementById("poll-content")?.value||"";var editor={default:"type_text",image:"type_image",video:"type_video",audio:"type_audio",html:"type_html"}[pollType]||"type_text",editor=document.getElementById(editor);let answers=[],answerExtras=[],imageUrls=[],videoUrls=[],audioUrls=[],htmlContents=[];editor&&editor.querySelectorAll(".polls-answer").forEach(item=>{var labelInput=item.querySelector('.wbpoll_answer, input[name="_wbpoll_answer[]"]');labelInput&&labelInput.value.trim()&&(answers.push(labelInput.value.trim()),answerExtras.push("default"===pollType?"default":pollType),"image"===pollType?(labelInput=item.querySelector('.wbpoll_image_answer_url, input[name="_wbpoll_full_size_image_answer[]"]'),imageUrls.push(labelInput?labelInput.value:"")):"video"===pollType?(labelInput=item.querySelector('.wbpoll_video_answer_url, input[name="_wbpoll_video_answer_url[]"]'),videoUrls.push(labelInput?labelInput.value:"")):"audio"===pollType?(labelInput=item.querySelector('.wbpoll_audio_answer_url, input[name="_wbpoll_audio_answer_url[]"]'),audioUrls.push(labelInput?labelInput.value:"")):"html"===pollType&&(labelInput=item.querySelector('.wbpoll_html_answer_textarea, textarea[name="_wbpoll_html_answer[]"]'),htmlContents.push(labelInput?labelInput.value:"")))}),answers.length<2?this.showToast(__("Please add at least 2 answer options","buddypress-polls"),"error"):(editor={title:title,content:content,poll_type:pollType,_wbpoll_answer:answers,_wbpoll_answer_extra:answerExtras},pollId&&(editor.poll_id=pollId),"image"===pollType&&0<imageUrls.length?editor._wbpoll_full_size_image_answer=imageUrls:"video"===pollType&&0<videoUrls.length?editor._wbpoll_video_answer_url=videoUrls:"audio"===pollType&&0<audioUrls.length?editor._wbpoll_audio_answer_url=audioUrls:"html"===pollType&&0<htmlContents.length&&(editor._wbpoll_html_answer=htmlContents),(title=form.querySelector('input[name="_wbpoll_never_expire"]:checked'))&&(editor._wbpoll_never_expire=title.value),(pollId=document.getElementById("_wbpoll_start_date"))&&pollId.value&&(editor._wbpoll_start_date=pollId.value),(title=document.getElementById("_wbpoll_end_date"))&&title.value&&(editor._wbpoll_end_date=title.value),(pollId=form.querySelector('input[name="_wbpoll_show_result_before_expire"]:checked'))&&(editor._wbpoll_show_result_before_expire=pollId.value),(title=form.querySelector('input[name="_wbpoll_multivote"]:checked'))&&(editor._wbpoll_multivote=title.value),(pollId=form.querySelectorAll('input[name="_wbpoll_add_additional_fields"]'))&&pollId.length&&(title=form.querySelector('input[name="_wbpoll_add_additional_fields"]:checked'),editor._wbpoll_add_additional_fields=title?title.value:"0"),submitBtn&&this.setButtonLoading(submitBtn,!0),pollId="undefined"!=typeof wbpollpublic?wbpollpublic.url:"",form="undefined"!=typeof wbpollpublic?wbpollpublic.rest_nonce:"",fetch(pollId+"/wp-json/wbpoll/v1/postpoll",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":form},body:JSON.stringify(editor)}).then(response=>response.json()).then(result=>{submitBtn&&this.setButtonLoading(submitBtn,!1),result.code&&result.message?this.showToast(result.message,"error"):(result=isEditing?__("Poll updated successfully!","buddypress-polls"):__("Poll created successfully!","buddypress-polls"),this.showToast(result,"success"),this.closePanel(),setTimeout(()=>{window.location.reload()},1e3))}).catch(error=>{console.error("Form submit error:",error),submitBtn&&this.setButtonLoading(submitBtn,!1),this.showToast(__("An error occurred. Please try again.","buddypress-polls"),"error")}))}else this.showToast(__("Please enter a poll title","buddypress-polls"),"error"),document.getElementById("polltitle")?.focus()}addAnswerField(){if(this.elements.answerList){var index=this.elements.answerList.querySelectorAll(".polls-answer").length+1;let answerHtml="";switch(this.getSelectedPollType()){case"image":answerHtml=this.createImageAnswerHTML(index,"","");break;case"video":answerHtml=this.createVideoAnswerHTML(index,"","");break;case"audio":answerHtml=this.createAudioAnswerHTML(index,"","");break;case"html":answerHtml=this.createHtmlAnswerHTML(index,"","");break;default:answerHtml=this.createTextAnswerHTML(index,"")}this.elements.answerList.insertAdjacentHTML("beforeend",answerHtml);var answersContainer,newAnswer=this.elements.answerList.lastElementChild,newAnswer=newAnswer?newAnswer.querySelector(".wbpoll_answer"):null;newAnswer&&(0<(answersContainer=(answersContainer=document.getElementById("polls-answers"))&&parseInt(answersContainer.dataset.answerLimit,10)||0)&&(newAnswer.setAttribute("maxlength",answersContainer),newAnswer.setAttribute("data-char-limit",answersContainer)),newAnswer.focus()),this.initSortable()}}removeAnswerField(answerEl){var answerList;answerEl&&(answerList=answerEl.closest(".polls-answers__list")||this.elements.answerList)&&(answerList.querySelectorAll(".polls-answer").length<=2?this.showToast(__("You need at least 2 answer options","buddypress-polls"),"error"):answerEl.remove())}resetForm(){var nativeForm;this.elements.form&&((nativeForm=this.elements.form.querySelector("form"))&&nativeForm.reset(),(nativeForm=document.getElementById("poll_id"))&&(nativeForm.value=""),(nativeForm=document.querySelector('input[name="poll_type"][value="default"]'))&&(nativeForm.checked=!0,this.handlePollTypeChange("default")),(nativeForm=document.querySelector('input[name="poll_expiry_option"][value="never"]'))&&(nativeForm.checked=!0,this.handleExpiryChange("never")),document.querySelectorAll(".polls-form__error").forEach(el=>{el.style.display="none",el.textContent=""}),"undefined"!=typeof tinyMCE)&&(nativeForm=tinyMCE.get("poll-content"))&&nativeForm.setContent("")}loadPollData(pollId){console.log("[PollsDashboard] wbpollpublic object:","undefined"!=typeof wbpollpublic?wbpollpublic:"NOT DEFINED");var siteUrl="undefined"!=typeof wbpollpublic?wbpollpublic.url:"",nonce="undefined"!=typeof wbpollpublic?wbpollpublic.rest_nonce:"";console.log("[PollsDashboard] Loading poll data for ID:",pollId),console.log("[PollsDashboard] Site URL:",siteUrl),console.log("[PollsDashboard] Nonce:",nonce),console.log("[PollsDashboard] Full API URL:",siteUrl+"/wp-json/wbpoll/v1/listpoll/id"),siteUrl?fetch(siteUrl+"/wp-json/wbpoll/v1/listpoll/id",{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":nonce},body:JSON.stringify({pollid:pollId})}).then(response=>(console.log("[PollsDashboard] Response status:",response.status),response.json())).then(apiData=>{var pollData;console.log("[PollsDashboard] API Response:",apiData),apiData&&apiData.id?(pollData={ID:apiData.id,post_title:apiData.title||"",post_content:apiData.content||"",poll_type:this.detectPollType(apiData.options),_wbpoll_never_expire:apiData.never_expire||"1",_wbpoll_start_date:apiData.start_time||"",_wbpoll_end_date:apiData.end_date||"",_wbpoll_show_result_before_expire:apiData.show_result_after_expire||"0",_wbpoll_multivote:apiData.multivote||"0",_wbpoll_add_additional_fields:apiData.add_additional_fields||"0",_wbpoll_content:apiData.show_description||"",options:apiData.options||{}},this.populateForm(pollData)):("404"===apiData.code?this.showToast(__("Poll not found.","buddypress-polls"),"error"):this.showToast(__("Failed to load poll data.","buddypress-polls"),"error"),this.closePanel())}).catch(error=>{console.error("Error loading poll:",error),this.showToast(__("Error loading poll data.","buddypress-polls"),"error"),this.closePanel()}):(console.error("[PollsDashboard] ERROR: siteUrl is empty! wbpollpublic may not be loaded."),this.showToast(__("Configuration error. Please refresh the page.","buddypress-polls"),"error"),this.closePanel())}detectPollType(options){return options&&"object"==typeof options&&(options=Object.values(options)[0])?options.image?"image":options.video?"video":options.audio?"audio":options.html?"html":"default":"default"}populateForm(pollData){var pollIdInput=document.getElementById("poll_id"),pollIdInput=(pollIdInput&&(pollIdInput.value=pollData.ID),document.getElementById("polltitle")),pollIdInput=(pollIdInput&&(pollIdInput.value=pollData.post_title||""),document.getElementById("poll-content")),editor=("undefined"!=typeof tinyMCE&&(editor=tinyMCE.get("poll-content"))?editor.setContent(pollData.post_content||""):pollIdInput&&(pollIdInput.value=pollData.post_content||""),pollData.poll_type||"default"),pollIdInput=document.querySelector(`input[name="poll_type"][value="${editor}"]`),pollIdInput=(pollIdInput&&(pollIdInput.checked=!0,this.handlePollTypeChange(editor)),document.getElementById("poll_type")),pollIdInput=(pollIdInput&&(pollIdInput.value=editor),this.setRadioValue("_wbpoll_never_expire",pollData._wbpoll_never_expire||"1"),this.setInputValue("_wbpoll_start_date",pollData._wbpoll_start_date||""),this.setInputValue("_wbpoll_end_date",pollData._wbpoll_end_date||""),this.setRadioValue("_wbpoll_show_result_before_expire",pollData._wbpoll_show_result_before_expire||"0"),this.setRadioValue("_wbpoll_multivote",pollData._wbpoll_multivote||"0"),this.setRadioValue("_wbpoll_add_additional_fields",pollData._wbpoll_add_additional_fields||"0"),"1"===pollData._wbpoll_never_expire),editor=pollIdInput?"never":"duration",pollIdInput=document.querySelector(`input[name="poll_expiry_option"][value="${editor}"]`);pollIdInput&&(pollIdInput.checked=!0,this.handleExpiryChange(editor)),this.populateAnswers(pollData.poll_type||"default",pollData.options||{})}populateAnswers(pollType,options){console.log("[PollsDashboard] Populating answers:",pollType,options);var optionKeys;let listId={default:"type_text",image:"type_image",video:"type_video",audio:"type_audio",html:"type_html"}[pollType]||"type_text",answerList=document.getElementById(listId);answerList?(document.querySelectorAll(".polls-answers__list").forEach(list=>{list.style.display=list.id===listId?"":"none"}),answerList.innerHTML="",0===(optionKeys=Object.keys(options)).length?console.warn("[PollsDashboard] No options to populate"):(optionKeys.forEach((key,index)=>{var key=options[key],label=key.label||"";let answerHtml="";"default"===pollType?answerHtml=this.createTextAnswerHTML(index,label):"image"===pollType?answerHtml=this.createImageAnswerHTML(index,label,key.image||""):"video"===pollType?answerHtml=this.createVideoAnswerHTML(index,label,key.video||""):"audio"===pollType?answerHtml=this.createAudioAnswerHTML(index,label,key.audio||""):"html"===pollType&&(answerHtml=this.createHtmlAnswerHTML(index,label,key.html||"")),answerList.insertAdjacentHTML("beforeend",answerHtml)}),this.initSortable())):console.warn("[PollsDashboard] Answer list not found:",listId)}createTextAnswerHTML(index,label){return`
			<div class="polls-answer" data-index="${index}">
				<div class="polls-answer__handle" aria-label="Drag to reorder">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6h8M4 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</div>
				<input type="text" class="polls-answer__input wbpoll_answer" name="_wbpoll_answer[]" value="${this.escapeHtml(label)}" placeholder="Enter option...">
				<input type="hidden" value="default" name="_wbpoll_answer_extra[][type]" class="wbpoll_answer_extra">
				<button type="button" class="polls-answer__remove" aria-label="Remove option">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</button>
			</div>`}createImageAnswerHTML(index,label,imageUrl){return`
			<div class="polls-answer polls-answer--media" data-index="${index}">
				<div class="polls-answer__handle" aria-label="Drag to reorder">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6h8M4 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</div>
				<div class="polls-answer__preview">${imageUrl?`<img src="${this.escapeHtml(imageUrl)}" alt="">`:""}</div>
				<div class="polls-answer__fields">
					<input type="text" class="polls-answer__input wbpoll_answer" name="_wbpoll_answer[]" value="${this.escapeHtml(label)}" placeholder="Option label...">
					<input type="hidden" value="image" name="_wbpoll_answer_extra[][type]" class="wbpoll_answer_extra">
					<div class="polls-answer__url-row">
						<input type="url" class="polls-answer__input wbpoll_image_answer_url" name="_wbpoll_full_size_image_answer[]" value="${this.escapeHtml(imageUrl)}" placeholder="Image URL...">
						<button type="button" class="polls-answer__media-btn bpolls-attach" data-type="image" aria-label="Choose image">
							<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/></svg>
						</button>
					</div>
				</div>
				<button type="button" class="polls-answer__remove" aria-label="Remove option">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</button>
			</div>`}createVideoAnswerHTML(index,label,videoUrl){return`
			<div class="polls-answer polls-answer--media" data-index="${index}">
				<div class="polls-answer__handle" aria-label="Drag to reorder">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6h8M4 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</div>
				<div class="polls-answer__preview"></div>
				<div class="polls-answer__fields">
					<input type="text" class="polls-answer__input wbpoll_answer" name="_wbpoll_answer[]" value="${this.escapeHtml(label)}" placeholder="Option label...">
					<input type="hidden" value="video" name="_wbpoll_answer_extra[][type]" class="wbpoll_answer_extra">
					<div class="polls-answer__url-row">
						<input type="url" class="polls-answer__input wbpoll_video_answer_url" name="_wbpoll_video_answer_url[]" value="${this.escapeHtml(videoUrl)}" placeholder="Video URL...">
						<button type="button" class="polls-answer__media-btn bpolls-attach" data-type="video" aria-label="Choose video">
							<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg>
						</button>
					</div>
				</div>
				<button type="button" class="polls-answer__remove" aria-label="Remove option">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</button>
			</div>`}createAudioAnswerHTML(index,label,audioUrl){return`
			<div class="polls-answer polls-answer--media" data-index="${index}">
				<div class="polls-answer__handle" aria-label="Drag to reorder">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6h8M4 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</div>
				<div class="polls-answer__preview"></div>
				<div class="polls-answer__fields">
					<input type="text" class="polls-answer__input wbpoll_answer" name="_wbpoll_answer[]" value="${this.escapeHtml(label)}" placeholder="Option label...">
					<input type="hidden" value="audio" name="_wbpoll_answer_extra[][type]" class="wbpoll_answer_extra">
					<div class="polls-answer__url-row">
						<input type="url" class="polls-answer__input wbpoll_audio_answer_url" name="_wbpoll_audio_answer_url[]" value="${this.escapeHtml(audioUrl)}" placeholder="Audio URL...">
						<button type="button" class="polls-answer__media-btn bpolls-attach" data-type="audio" aria-label="Choose audio">
							<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
						</button>
					</div>
				</div>
				<button type="button" class="polls-answer__remove" aria-label="Remove option">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</button>
			</div>`}createHtmlAnswerHTML(index,label,htmlContent){return`
			<div class="polls-answer polls-answer--html" data-index="${index}">
				<div class="polls-answer__handle" aria-label="Drag to reorder">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 6h8M4 10h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</div>
				<div class="polls-answer__fields polls-answer__fields--full">
					<input type="text" class="polls-answer__input wbpoll_answer" name="_wbpoll_answer[]" value="${this.escapeHtml(label)}" placeholder="Option label...">
					<textarea class="polls-answer__textarea wbpoll_html_answer_textarea" name="_wbpoll_html_answer[]" placeholder="HTML content...">${this.escapeHtml(htmlContent)}</textarea>
					<input type="hidden" value="html" name="_wbpoll_answer_extra[][type]" class="wbpoll_answer_extra">
				</div>
				<button type="button" class="polls-answer__remove" aria-label="Remove option">
					<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
				</button>
			</div>`}escapeHtml(text){var div;return text?((div=document.createElement("div")).textContent=text,div.innerHTML):""}setRadioValue(name,value){name=document.querySelector('input[name="'+name+'"][value="'+value+'"]');name&&(name.checked=!0,name.dispatchEvent(new Event("change")))}setInputValue(id,value){id=document.getElementById(id);id&&(id.value=value)}initSortable(){"undefined"==typeof Sortable?console.warn("SortableJS not loaded. Drag-drop disabled."):(this.state.sortables&&this.state.sortables.forEach(s=>s.destroy()),this.state.sortables=[],this.elements.answerLists.forEach(list=>{list=new Sortable(list,{handle:".polls-answer__handle",animation:200,ghostClass:"is-dragging",chosenClass:"is-chosen",dragClass:"is-drag",onEnd:()=>{this.updateAnswerIndices()}});this.state.sortables.push(list)}))}updateAnswerIndices(){this.elements.answerList&&this.elements.answerList.querySelectorAll(".polls-answer").forEach((answer,index)=>{answer.dataset.index=index+1})}showToast(message,type="success",title=""){this.elements.toastContainer||this.createToastContainer();let toast=document.createElement("div");toast.className="polls-toast polls-toast--"+type,toast.setAttribute("role","alert");var iconWrapper=document.createElement("span"),type=(iconWrapper.className="polls-toast__icon",this.createToastIcon(type)),type=(iconWrapper.appendChild(type),toast.appendChild(iconWrapper),document.createElement("div")),title=(type.className="polls-toast__content",title&&((iconWrapper=document.createElement("h4")).className="polls-toast__title",iconWrapper.textContent=title,type.appendChild(iconWrapper)),document.createElement("p")),iconWrapper=(title.className="polls-toast__message",title.textContent=message,type.appendChild(title),toast.appendChild(type),document.createElement("button")),message=(iconWrapper.type="button",iconWrapper.className="polls-toast__close",iconWrapper.setAttribute("aria-label",__("Close notification","buddypress-polls")),document.createElementNS("http://www.w3.org/2000/svg","svg")),title=(message.setAttribute("width","16"),message.setAttribute("height","16"),message.setAttribute("viewBox","0 0 24 24"),message.setAttribute("fill","none"),message.setAttribute("stroke","currentColor"),message.setAttribute("stroke-width","2"),document.createElementNS("http://www.w3.org/2000/svg","path")),type=(title.setAttribute("d","M18 6L6 18M6 6l12 12"),message.appendChild(title),iconWrapper.appendChild(message),toast.appendChild(iconWrapper),this.elements.toastContainer.appendChild(toast),requestAnimationFrame(()=>{toast.classList.add("is-visible")}),iconWrapper.addEventListener("click",()=>{this.hideToast(toast)}),setTimeout(()=>{this.hideToast(toast)},4e3));return toast._autoHideTimer=type,toast}createToastIcon(type){var svg=document.createElementNS("http://www.w3.org/2000/svg","svg");if(svg.setAttribute("width","20"),svg.setAttribute("height","20"),svg.setAttribute("viewBox","0 0 24 24"),svg.setAttribute("fill","none"),svg.setAttribute("stroke","currentColor"),svg.setAttribute("stroke-width","2"),"success"===type){var path1=document.createElementNS("http://www.w3.org/2000/svg","path"),path1=(path1.setAttribute("d","M22 11.08V12a10 10 0 11-5.93-9.14"),svg.appendChild(path1),document.createElementNS("http://www.w3.org/2000/svg","path"));path1.setAttribute("d","M22 4L12 14.01l-3-3"),svg.appendChild(path1)}else if("error"===type){path1=document.createElementNS("http://www.w3.org/2000/svg","circle"),path1=(path1.setAttribute("cx","12"),path1.setAttribute("cy","12"),path1.setAttribute("r","10"),svg.appendChild(path1),document.createElementNS("http://www.w3.org/2000/svg","line")),path1=(path1.setAttribute("x1","15"),path1.setAttribute("y1","9"),path1.setAttribute("x2","9"),path1.setAttribute("y2","15"),svg.appendChild(path1),document.createElementNS("http://www.w3.org/2000/svg","line"));path1.setAttribute("x1","9"),path1.setAttribute("y1","9"),path1.setAttribute("x2","15"),path1.setAttribute("y2","15"),svg.appendChild(path1)}else if("warning"===type){path1=document.createElementNS("http://www.w3.org/2000/svg","path");path1.setAttribute("d","M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"),svg.appendChild(path1);let line1=document.createElementNS("http://www.w3.org/2000/svg","line"),line2=(line1.setAttribute("x1","12"),line1.setAttribute("y1","9"),line1.setAttribute("x2","12"),line1.setAttribute("y2","13"),svg.appendChild(line1),document.createElementNS("http://www.w3.org/2000/svg","line"));line2.setAttribute("x1","12"),line2.setAttribute("y1","17"),line2.setAttribute("x2","12.01"),line2.setAttribute("y2","17"),svg.appendChild(line2)}else{let circle=document.createElementNS("http://www.w3.org/2000/svg","circle"),line1=(circle.setAttribute("cx","12"),circle.setAttribute("cy","12"),circle.setAttribute("r","10"),svg.appendChild(circle),document.createElementNS("http://www.w3.org/2000/svg","line")),line2=(line1.setAttribute("x1","12"),line1.setAttribute("y1","16"),line1.setAttribute("x2","12"),line1.setAttribute("y2","12"),svg.appendChild(line1),document.createElementNS("http://www.w3.org/2000/svg","line"));line2.setAttribute("x1","12"),line2.setAttribute("y1","8"),line2.setAttribute("x2","12.01"),line2.setAttribute("y2","8"),svg.appendChild(line2)}return svg}hideToast(toast){toast&&!toast._isHiding&&(toast._isHiding=!0,toast._autoHideTimer&&clearTimeout(toast._autoHideTimer),toast.classList.add("is-hiding"),toast.classList.remove("is-visible"),setTimeout(()=>{toast.parentNode&&toast.remove()},300))}clearAllToasts(){this.elements.toastContainer&&this.elements.toastContainer.querySelectorAll(".polls-toast").forEach(toast=>this.hideToast(toast))}handleUrlParams(){var urlParams=new URLSearchParams(window.location.search),pollId=urlParams.get("poll_id")||urlParams.get("id"),action=urlParams.get("action"),urlParams=urlParams.get("create"),isEditBlocked="true"===this.elements.panel?.dataset.editBlocked;!pollId||action&&"edit"!==action||isEditBlocked?"1"===urlParams?this.openPanel(null):(this.elements.panel&&(this.elements.panel.classList.remove("is-open"),this.elements.panel.setAttribute("aria-hidden","true")),this.elements.panelOverlay&&this.elements.panelOverlay.classList.remove("is-visible")):this.openPanel(pollId)}}document.addEventListener("DOMContentLoaded",()=>{window.pollsDashboard=new PollsDashboard}),($=>{void 0!==$&&$(document).ready(function(){$(".pause_poll").on("click",function(){var pollid,pause_poll;window.pollsDashboard||(pollid=$(this).data("id"),pause_poll=$(this).data("value"),$.ajax({url:wbpollpublic.url+"/wp-json/wbpoll/v1/listpoll/pause/poll",type:"POST",contentType:"application/json",data:JSON.stringify({pollid:pollid,_wbpoll_pause_poll:pause_poll}),beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wbpollpublic.rest_nonce)},success:function(response){response.success&&location.reload()}}))}),$(".delete_poll").on("click",function(){var pollid;window.pollsDashboard||confirm(__("Are you sure you want to delete this poll?","buddypress-polls"))&&(pollid=$(this).data("id"),$.ajax({url:wbpollpublic.url+"/wp-json/wbpoll/v1/listpoll/delete/poll",type:"POST",contentType:"application/json",data:JSON.stringify({pollid:pollid}),beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wbpollpublic.rest_nonce)},success:function(response){response.success&&location.reload()}}))}),$(".dashboard-sub-tab").on("click",function(e){window.pollsDashboard||(e.preventDefault(),e=$(this).data("text"),$(".dashboard-sub-tab").removeClass("selected"),$(".tab-list").removeClass("active"),$(this).addClass("selected"),"publish"===e?$("#publish-listing").addClass("active"):"pending"===e?$("#pending-listing").addClass("active"):"draft"===e&&$("#draft-listing").addClass("active"))})})})("undefined"!=typeof jQuery?jQuery:null);